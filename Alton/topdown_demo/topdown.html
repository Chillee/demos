<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>topdown</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/phaser/2.4.7/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            background-color: #233037;
        }
        canvas {
            border: 1px solid black;
            cursor: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwA  ADsMAAA7DAcdvqGQAAAAZdEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41LjbQg61aAAAADUlEQVQYV2P4//8/IwAI/QL/+TZZdwAAAABJRU5ErkJggg=='),
            url(images/blank.cur),
            none !important;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(768, 576, Phaser.AUTO, '', { preload: preload, create: create, update: update, render: render }, false, false);

function preload() {
    game.scale.pageAlignHorizontally = true;
    game.scale.pageAlignVertically = true;
    game.scale.scaleMode = Phaser.ScaleManager.USER_SCALE;
    if(window.innerWidth >= game.width * 2 && window.innerHeight + 1 >= game.height * 2) game.scale.setUserScale(2, 2, 0, 0);

    game.renderer.renderSession.roundPixels = false;  
    Phaser.Canvas.setImageRenderingCrisp(this.game.canvas);

    game.load.spritesheet('player', 'assets/tileset.png', 24, 48);
    game.load.spritesheet('24tileset', 'assets/tileset.png', 24, 24);
    game.load.image('sheet', 'assets/tileset.png');
    game.load.spritesheet('12x12sheet', 'assets/tileset.png', 12, 12);
    game.load.image('level', 'assets/level.png');
    game.load.image('tiny', 'assets/tiny.png');
}


var TILESIZE = 24;

var player;
var walls;
var bullets;
var cursors;
var crosshair;

function create() {

    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);

    walls = game.add.group();

    var level = game.add.bitmapData(242, 180);
    level.draw(game.cache.getImage('level'), 0, 0);
    level.update();
    game.world.resize(level.width * TILESIZE, level.height * TILESIZE);
    for(var x = 0; x < level.width; x++){
        for(var y = 0; y < level.height; y++){
            var color = level.getPixelRGB(x, y);
            console.log(color);
            if(color.r == 0 && color.g == 0 && color.b == 0){
                var wall = walls.create(x * TILESIZE, y * TILESIZE, 'tiny');
                game.physics.arcade.enable(wall);
                wall.autoCull = true;
                wall.checkWorldBounds = true;
                wall.body.immovable = true;
            }
            if(color.r == 255 && color.g == 0 && color.b == 0){
                player = game.add.sprite(x * TILESIZE, y * TILESIZE, 'player');
            }
        }
    }

    // game.add.sprite(0, 0, 'level');

    // The player and its settings

    //  We need to enable physics on the player
    game.physics.arcade.enable(player);
    player.body.setSize(12, 21, 6, 24);
    player.body.debug = true;

    player.body.collideWorldBounds = true;

    //  Our two animations, walking left and right.
    var fps = 16;
    player.animations.add('NW', [160, 161, 162, 163, 164, 165, 166, 167], fps, true);
    player.animations.add('N', [128, 129, 130, 131, 132, 133, 134, 135], fps, true);
    player.animations.add('NE', [96, 97, 98, 99, 100, 101, 102, 103], fps, true);
    player.animations.add('E', [64, 65, 66, 67, 68, 69, 70, 71], fps, true);
    player.animations.add('SE', [32, 33, 34, 35, 36, 37, 38, 39], fps, true);
    player.animations.add('S', [0, 1, 2, 3, 4, 5, 6, 7], fps, true);
    player.animations.add('SW', [224, 225, 226, 227, 228, 229, 230, 231], fps, true);
    player.animations.add('W', [192, 193, 194, 195, 196, 197, 198, 199], fps, true);
    player.animations.add('idle', [0], 5, true);

    bullets = game.add.group();
    bullets.enableBody = true;
    bullets.createMultiple(16, '12x12sheet');
    bullets.setAll('checkWorldBounds', true);
    bullets.setAll('outOfBoundsKill', true);
    bullets.setAll('anchor.x', 0.5);
    bullets.setAll('anchor.y', 0.5);
    bullets.forEach(function(bullet){
        bullet.body.setSize(8, 8, 0, 0);
        bullet.animations.add('shoot', [514], 30, false);
        bullet.animations.add('kill', [515, 516, 517], 40, false);
    }, this);

    crosshair = game.add.sprite(0, 0, '24tileset', 128); //128
    crosshair.enableBody = false;
    crosshair.anchor.set(.5, .5);

    game.camera.follow(player, Phaser.Camera.FOLLOW_wallER);
    game.camera.roundPx = false;
    game.time.advancedTiming = true;
}

function render() {
    game.debug.text(game.time.fps, 32, 32);
    bullets.forEach(function(bullet){
        //game.debug.body(bullet);
    }, this);
}

var nextFire = 0;
var fireRate = 160;
function shoot(){
    if (game.time.now > nextFire && bullets.countDead() > 0)
    {
        nextFire = game.time.now + fireRate;

        var bullet = bullets.getFirstDead();
        bullet.animations.play('shoot');

        bullet.reset(player.body.x + player.body.halfWidth, player.body.y + player.body.halfHeight);

        game.physics.arcade.moveToPointer(bullet, game.rnd.integerInRange(700, 800));
        bullet.body.velocity.x += game.rnd.realInRange(-50, 50);
        bullet.body.velocity.y += game.rnd.realInRange(-50, 50);
    }
}

function bulletHit(bullet, wall){
    bullet.body.velocity.set(0);
    bullet.animations.play('kill', null, null, true);
}

function update() {
    crosshair.position.set(game.camera.x + game.input.mousePointer.x, game.camera.y + game.input.mousePointer.y);

    if(game.input.activePointer.isDown){
        shoot();
    }

    //  Collide the player and the stars with the walls
    game.physics.arcade.collide(player, walls);
    //game.physics.arcade.collide(bullets, walls, bulletHit);

    //  Reset the players velocity (movement)
    player.body.velocity.set(0, 0);

    var v = 100;
    if(game.input.keyboard.isDown(Phaser.Keyboard.W)){
        player.body.velocity.y -= v;
    }
    if(game.input.keyboard.isDown(Phaser.Keyboard.A)){
        player.body.velocity.x -= v;
    }
    if(game.input.keyboard.isDown(Phaser.Keyboard.S)){
        player.body.velocity.y += v;
    }
    if(game.input.keyboard.isDown(Phaser.Keyboard.D)){
        player.body.velocity.x += v;
    }

    if(player.body.velocity.x == -v && player.body.velocity.y == -v){
        player.animations.play('NW');
    }
    else if(player.body.velocity.x == 0 && player.body.velocity.y == -v){
        player.animations.play('N');
    }
    else if(player.body.velocity.x == v && player.body.velocity.y == -v){
        player.animations.play('NE');
    }
    else if(player.body.velocity.x == v && player.body.velocity.y == 0){
        player.animations.play('E');
    }
    else if(player.body.velocity.x == v && player.body.velocity.y == v){
        player.animations.play('SE');
    }
    else if(player.body.velocity.x == 0 && player.body.velocity.y == v){
        player.animations.play('S');
    }
    else if(player.body.velocity.x == -v && player.body.velocity.y == v){
        player.animations.play('SW');
    }
    else if(player.body.velocity.x == -v && player.body.velocity.y == 0){
        player.animations.play('W');
    }
    else {
        //  Stand still
        player.animations.play('idle');
    }
}

</script>

</body>
</html>