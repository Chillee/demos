<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 8</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/phaser/2.4.7/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            background-color: #233037;
        }
        canvas {
            border: 1px solid black;
            cursor: none;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(384, 384, Phaser.AUTO, '', { preload: preload, create: create, update: update, render: render }, false, false);

function preload() {
    game.scale.pageAlignHorizontally = true;
    game.scale.pageAlignVertically = true;
    game.scale.scaleMode = Phaser.ScaleManager.USER_SCALE;
    if(window.innerWidth >= game.width * 2 && window.innerHeight + 1 >= game.height * 2) game.scale.setUserScale(2, 2, 0, 0);

    game.renderer.renderSession.roundPixels = true;  
    Phaser.Canvas.setImageRenderingCrisp(this.game.canvas);

    game.load.spritesheet('player', 'assets/tileset.png', 24, 48);
    game.load.spritesheet('24tileset', 'assets/tileset.png', 24, 24);
    game.load.image('sheet', 'assets/tileset.png');
    game.load.spritesheet('12x12sheet', 'assets/tileset.png', 12, 12);
}

var player;
var platforms;
var bullets;
var cursors;
var crosshair;

function create() {

    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);
    //  A simple background for our game

    //  The platforms group contains the ground and the 2 ledges we can jump on
    platforms = game.add.group();

    //  We will enable physics for any object that is created in this group
    platforms.enableBody = true;

    // Here we create the ground.

    game.world.resize(512, 512);
    for(var i = 0; i < game.world.width / 24; i++){
        var platform = platforms.create(i*24, game.world.height - 96, 'player', 127);
        platform.body.immovable = true;
        var platform2 = platforms.create(i*24, game.world.height - 80, 'player', 127);
        platform2.body.immovable = true;
        for(var j = 0; j < 80 / 16; j++){
            var platform3 = platforms.create(i*24, game.world.height - j*24, 'player', 127);
        }
    }

    game.add.sprite(0, 0, 'sheet');

    // The player and its settings
    player = game.add.sprite(32, game.world.height - 150, 'player');

    //  We need to enable physics on the player
    game.physics.arcade.enable(player);
    player.body.setSize(12, 21, 6, 24);
    player.body.debug = true;

    player.body.collideWorldBounds = true;

    //  Our two animations, walking left and right.
    player.animations.add('NW', [5, 21, 37, 53], 8, true);
    player.animations.add('N', [4, 20, 36, 52], 8, true);
    player.animations.add('NE', [3, 19, 35, 51], 8, true);
    player.animations.add('E', [2, 18, 34, 50], 8, true);
    player.animations.add('SE', [1, 17, 33, 49], 8, true);
    player.animations.add('S', [0, 16, 32, 48], 8, true);
    player.animations.add('SW', [7, 23, 39, 55], 8, true);
    player.animations.add('W', [6, 22, 38, 54], 8, true);
    player.animations.add('idle', [0], 5, true);

    bullets = game.add.group();
    bullets.enableBody = true;
    bullets.createMultiple(64, '12x12sheet', 514);
    bullets.setAll('checkWorldBounds', true);
    bullets.setAll('outOfBoundsKill', true);
    bullets.setAll('anchor.x', .5);
    bullets.setAll('anchor.y', .5);

    crosshair = game.add.sprite(0, 0, '24tileset', 128); //128
    crosshair.enableBody = false;
    crosshair.anchor.set(.5, .5);

    game.camera.follow(player, Phaser.Camera.FOLLOW_PLATFORMER);
    game.camera.roundPx = false;
    game.time.advancedTiming = true;
}

function render() {
    game.debug.text(game.time.fps, 32, 32);
}

var nextFire = 0;
var fireRate = 200;
function shoot(){
    if (game.time.now > nextFire && bullets.countDead() > 0)
    {
        nextFire = game.time.now + fireRate;

        var bullet = bullets.getFirstDead();

        bullet.reset(player.body.x + player.body.halfWidth, player.body.y + player.body.halfHeight);

        game.physics.arcade.moveToPointer(bullet, 600);
    }
}

function update() {
    crosshair.position.set(game.camera.x + game.input.mousePointer.x, game.camera.y + game.input.mousePointer.y);

    if(game.input.activePointer.isDown){
        shoot();
    }

    //  Collide the player and the stars with the platforms
    game.physics.arcade.collide(player, platforms);

    //  Reset the players velocity (movement)
    player.body.velocity.set(0, 0);

    var v = 100;
    if(game.input.keyboard.isDown(Phaser.Keyboard.W)){
        player.body.velocity.y -= v;
    }
    if(game.input.keyboard.isDown(Phaser.Keyboard.A)){
        player.body.velocity.x -= v;
    }
    if(game.input.keyboard.isDown(Phaser.Keyboard.S)){
        player.body.velocity.y += v;
    }
    if(game.input.keyboard.isDown(Phaser.Keyboard.D)){
        player.body.velocity.x += v;
    }

    if(player.body.velocity.x == -v && player.body.velocity.y == -v){
        player.animations.play('NW');
    }
    else if(player.body.velocity.x == 0 && player.body.velocity.y == -v){
        player.animations.play('N');
    }
    else if(player.body.velocity.x == v && player.body.velocity.y == -v){
        player.animations.play('NE');
    }
    else if(player.body.velocity.x == v && player.body.velocity.y == 0){
        player.animations.play('E');
    }
    else if(player.body.velocity.x == v && player.body.velocity.y == v){
        player.animations.play('SE');
    }
    else if(player.body.velocity.x == 0 && player.body.velocity.y == v){
        player.animations.play('S');
    }
    else if(player.body.velocity.x == -v && player.body.velocity.y == v){
        player.animations.play('SW');
    }
    else if(player.body.velocity.x == -v && player.body.velocity.y == 0){
        player.animations.play('W');
    }
    else {
        //  Stand still
        player.animations.play('idle');
    }
}

</script>

</body>
</html>